<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sanal Asistan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ROOT CAUSE FIX: Force light mode color scheme */
        html, body {
            color-scheme: light !important;
        }
        
        /* FORCE CURSOR VISIBILITY */
        html, body, div {
            cursor: auto !important;
        }
        input, textarea {
            cursor: text !important;
            caret-color: #9333ea !important; /* Purple blinking line */
            color: black !important;
            color-scheme: light !important; /* Forces dark cursor on light background */
        }
        button {
            cursor: pointer !important;
        }
        
        /* Direct ID targeting */
        #message-input {
            cursor: text !important;
            caret-color: #9333ea !important;
            color: #000000 !important;
            color-scheme: light !important;
            outline: none !important;
            position: relative !important;
            z-index: 100 !important;
        }
        
        .chat-container {
            color-scheme: light !important;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Prevent zoom on double-tap for mobile */
        body, input, button {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 h-[100dvh] flex flex-col overflow-hidden !cursor-default">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-50 via-purple-50 to-indigo-50 border-b border-gray-200 shadow-sm">
        <div class="container mx-auto max-w-4xl px-4 py-4">
            <div class="flex items-center space-x-3">
                <!-- Professional Avatar Circle with Ring -->
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg ring-2 ring-white">
                    <span class="text-white font-bold text-xl">{{ business_name[0].upper() }}</span>
                </div>
                
                <!-- Name and Status -->
                <div class="flex-1">
                    <h1 class="text-lg font-semibold text-gray-900">{{ business_name }}</h1>
                    <div class="flex items-center space-x-1.5">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
                        <span class="text-xs text-gray-600">Çevrimiçi</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="flex-1 overflow-hidden flex flex-col !cursor-default">
        <div class="container mx-auto max-w-4xl h-full flex flex-col !cursor-default">
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth hide-scrollbar !cursor-default">
                <!-- Welcome Message -->
                <div class="flex justify-start items-end space-x-2">
                    <!-- Bot Avatar -->
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-md">
                        <span class="text-white font-semibold text-sm md:text-base">{{ business_name[0].upper() }}</span>
                    </div>
                    <!-- Bot Message -->
                    <div class="bg-gray-100 rounded-3xl rounded-bl-md shadow-sm p-3 md:p-4 max-w-[75%] md:max-w-md">
                        <p class="text-gray-800 leading-relaxed text-sm md:text-base">Merhaba! Ben {{ business_name }} sanal asistanıyım. Size nasıl yardımcı olabilirim?</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area - Fixed at bottom for mobile -->
        <div class="sticky bottom-0 bg-white rounded-t-2xl shadow-2xl p-3 md:p-5 safe-area-inset-bottom">
            <div class="container mx-auto max-w-4xl" style="color-scheme: light;">
                <form id="chat-form" class="flex items-center space-x-2 md:space-x-3">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Mesajınızı yazın..." 
                        class="flex-1 bg-white border-none rounded-full px-4 md:px-6 py-3.5 text-base md:text-base text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all min-h-[48px]"
                        style="color: black !important; caret-color: #9333ea !important; cursor: text !important;"
                        autocomplete="off"
                        required
                    >
                    <button 
                        type="submit" 
                        id="send-btn"
                        class="w-12 h-12 min-w-[48px] min-h-[48px] bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transition-all duration-200 active:scale-95 md:hover:scale-110 flex-shrink-0"
                    >
                        <!-- Paper Airplane SVG Icon -->
                        <svg class="w-5 h-5 text-white transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Simplified cursor enforcement
        messageInput.addEventListener('focus', () => {
            messageInput.style.cursor = 'text';
            messageInput.style.caretColor = '#9333ea';
        });

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Add user message to chat
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            messageDiv.innerHTML = `
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-3xl rounded-br-md shadow-lg p-3 md:p-4 max-w-[75%] md:max-w-md">
                    <p class="leading-relaxed text-sm md:text-base">${escapeHtml(text)}</p>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add bot message to chat
        function addBotMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start items-end space-x-2';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-md">
                    <span class="text-white font-semibold text-sm md:text-base">{{ business_name[0].upper() }}</span>
                </div>
                <div class="bg-gray-100 rounded-3xl rounded-bl-md shadow-sm p-3 md:p-4 max-w-[75%] md:max-w-md">
                    <p class="text-gray-800 leading-relaxed text-sm md:text-base">${escapeHtml(text)}</p>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add loading indicator
        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'flex justify-start items-end space-x-2';
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-md">
                    <span class="text-white font-semibold text-sm md:text-base">{{ business_name[0].upper() }}</span>
                </div>
                <div class="bg-gray-100 rounded-3xl rounded-bl-md shadow-sm p-3 md:p-4">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            scrollToBottom();
        }

        // Remove loading indicator
        function removeLoadingMessage() {
            const loading = document.getElementById('loading-indicator');
            if (loading) {
                loading.remove();
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Handle form submission
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;

            // Disable input while processing
            messageInput.disabled = true;
            sendBtn.disabled = true;

            // Add user message to chat
            addUserMessage(message);
            messageInput.value = '';

            // Add loading indicator
            addLoadingMessage();

            try {
                // Send message to backend
                const response = await fetch('/chat-api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();

                // Remove loading indicator
                removeLoadingMessage();

                if (response.ok) {
                    // Add bot response
                    addBotMessage(data.reply);
                } else {
                    // Show error
                    addBotMessage('❌ Hata: ' + (data.error || 'Bir sorun oluştu.'));
                }
            } catch (error) {
                removeLoadingMessage();
                addBotMessage('❌ Bağlantı hatası. Lütfen tekrar deneyin.');
                console.error('Error:', error);
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            }
        });

        // Focus on input on page load
        messageInput.focus();

        // Initial scroll
        scrollToBottom();
    </script>
</body>
</html>
